import ArrayBufferSlice from '../ArrayBufferSlice';
import { mat4, vec2, vec3 } from 'gl-matrix';
import { SceneGroup, SceneDesc, SceneGfx, ViewerRenderInput } from "../viewer";
import * as Viewer from "../viewer";
import { GfxDevice } from "../gfx/platform/GfxPlatform";
import { SceneContext } from "../SceneBase";
import { IS_DEVELOPMENT } from "../BuildVersion";
import { assert, hexzero, hexzero0x, leftPad } from '../util';
import { NamedArrayBufferSlice } from "../DataFetcher";
import { downloadCanvasAsPng, downloadText } from "../DownloadUtils";
import { range, range_end } from '../MathHelpers';
import { downloadBuffer } from '../DownloadUtils';
import { makeZipFile, ZipFileEntry } from '../ZipFile';
import { SlyRenderer } from './SlyRenderer';
import * as Settings from './SlyConstants';
import * as Data from './SlyData';
import { DataStream } from "./DataStream";
import { sprintf } from "./sprintf";

const pathBase = `Sly2`;

// TODO: move to other file
interface ObjectEntry {
    name: string;
    type: string; // char
    count: number;
}
function parseObjectEntries(stream: DataStream): ObjectEntry[] {
    let objects: ObjectEntry[] = [];

    let objectCount = stream.readUint16();
    for (let i = 0; i < objectCount; ++i) {
        let resourceDescriptorStr = stream.readString(0x40);
        let type = resourceDescriptorStr[3];
        let name = resourceDescriptorStr.substr(4);

        stream.skip(4 * 4);

        let count = stream.readUint32();

        objects.push({ name, type, count });
    }

    return objects;
}

interface Object_ {
}

let enc = new TextEncoder();

// function parseObject(stream: DataStream, scriptOffsets: (number[] | null)): Object {
// }

export const SCRIPTS_EXPORT = true;

class Sly2LevelSceneDesc implements SceneDesc {
    constructor(public id: string, public name: string, private objectOffsets: number[], private scriptOffsets: (number[] | null)) {
    }

    public async createScene(device: GfxDevice, context: SceneContext): Promise<SceneGfx> {
        // TODO? Use compressed original files (orig. or zip/etc), or decompressed trimmed files

        const bin = await context.dataFetcher.fetchData(`${pathBase}/${this.id}.slyZ.dec`)
        let stream = new DataStream(bin);

        console.log(`loaded ${pathBase}/${this.id} of size ${bin.byteLength}`);

        let objectEntries = parseObjectEntries(stream);
        console.log(objectEntries);

        // TODO: refactor to func

        let scriptFileEntries: ZipFileEntry[] = [];

        let scriptIndex = 0;
        for (let i = 0; i < objectEntries.length; ++i) {
            let objectEntry = objectEntries[i];
            let objectOffset = this.objectOffsets[i];

            stream.offs = objectOffset;

            let textureSize = stream.readUint32();
            stream.skip(4);
            let hasScripts = (stream.readUint32() != 0);

            if (hasScripts && this.scriptOffsets) {
                let prevOffs = stream.offs;
                while (scriptIndex < this.scriptOffsets.length) {
                    let scriptOffset = this.scriptOffsets[scriptIndex];

                    if (i >= objectEntries.length || scriptOffset > this.objectOffsets[i + 1])
                        break;

                    stream.offs = scriptOffset;
                    let str0 = stream.readString(stream.readUint16());
                    let str1 = stream.readString(stream.readUint16());
                    let str2 = stream.readString(stream.readUint16());

                    if (str1 !== "")
                        console.info(`non0 str1: ${str1}`);

                    let filename = `${objectEntry.name}/${str0.replace(/\|/g, ",")}.scm`;
                    let data = new ArrayBufferSlice(enc.encode(str2).buffer);

                    scriptFileEntries.push({ filename, data });

                    ++scriptIndex;
                }
                stream.offs = prevOffs;
            }
        }

        const zipFile = makeZipFile(scriptFileEntries);
        downloadBuffer(`${this.id}_scripts.zip`, zipFile);

        const renderer = new SlyRenderer(device, [], [], [], [], []);
        return renderer;
    }
}

let objectOffsets_f_nightclub_exterior = [0x0FD1A0, 0x0FD560, 0x10C420, 0x113EA0, 0x114C10, 0x116590, 0x117F10, 0x119900, 0x11B290, 0x13EA00, 0x140350, 0x141CF0, 0x159F50, 0x15ACD0, 0x15C670, 0x1629E0, 0x168C20, 0x1D6C80, 0x1ECD50, 0x1EE6F0, 0x1F3590, 0x1F4F00, 0x1F4F80, 0x20ECA0, 0x220EE0, 0x2242D0, 0x225C30, 0x2276E0, 0x23CFA0, 0x248880, 0x24A220, 0x24EBB0, 0x25D990, 0x26F8D0, 0x291490, 0x2A9EB0, 0x2EC060, 0x2EE4D0, 0x2F4720, 0x2F60C0, 0x2FEDA0, 0x314B50, 0x32A880, 0x394170, 0x3A3030, 0x3A3B30, 0x3A8200, 0x3AA360, 0x3AB090, 0x3B57F0, 0x3B6540, 0x42D320, 0x42ECB0, 0x430650, 0x43E870, 0x44DE30, 0x471CF0, 0x480990, 0x491880, 0x493230, 0x525B50, 0x526870, 0x5340F0, 0x535500, 0x592630, 0x596FB0, 0x59B930, 0x59D2E0, 0x5A9600, 0x5B3C10, 0x5C0070, 0x5CA750, 0x5CD970, 0x5CDBB0, 0x5CF520, 0x5D7500, 0x5DA550, 0x5E0820, 0x5E9260, 0x5F5580, 0x5F63B0, 0x6085F0, 0x608FE0, 0x62B250, 0x62CBE0, 0x6347F0, 0x636170, 0x639340, 0x63DCD0, 0x654750, 0x655CE0, 0x65BEE0, 0x65BF60, 0x662180, 0x6D4BD0, 0x6DAE30, 0x6DBB30, 0x6E96C0, 0x730CF0, 0x735660, 0x736FF0, 0x73A9B0, 0x751430, 0x75D750, 0x769A70, 0x803D50, 0x8072C0, 0x80CED0, 0x81B3A0, 0x8286A0, 0x83C8C0, 0x83DA50, 0x83E7C0, 0x83F560, 0x84BFE0, 0x84D990, 0x876800, 0x88AAE0, 0x895220, 0x8A9EE0, 0x8BA460, 0x8C4CF0, 0xA1DBE0, 0xA25740, 0xA2A4F0, 0xA32200, 0xA32F50, 0xA4E6A0, 0xA53E70, 0xA5B9E0, 0xA6CE90, 0xA73E40, 0xA79200, 0xA7C8A0, 0xA83AE0, 0xC87BF0, 0xC89590, 0xC8A2E0, 0xC8D4A0, 0xC8EE20, 0xC93780, 0xC95120, 0xC99AA0, 0xC9A810, 0xC9C170, 0xCA5F30, 0xCA7890, 0xCA85F0, 0xDA03A0, 0xDCFB60, 0xDD2E70, 0xDD6030, 0xDDA990, 0xE35320, 0xE775A0, 0xE7FB40, 0xE8AE20, 0xE8C790, 0xE8E100, 0xE8FA90, 0xE943F0, 0xE94470, 0xEA6E60, 0xEA8820, 0xEAA190, 0xEABB30, 0xEAD4D0, 0xEAE230, 0xEB0D40, 0xEB26E0, 0xEB7040, 0xEEBB50, 0xEF1AC0, 0xEF7D00, 0xEF9660, 0x10822F0, 0x1088550, 0x1089EE0, 0x108B850, 0x10A7740, 0x10A84C0, 0x10A9E60, 0x123EAD0, 0x1249C20, 0x125D750, 0x1267100, 0x1267AF0, 0x1268840, 0x12752C0, 0x1276C50, 0x12779C0, 0x12804C0, 0x1286730, 0x12CD030, 0x12D02C0, 0x12D1020, 0x12D80F0, 0x12EA330, 0x12F0560, 0x12FE5C0, 0x12FFF50, 0x13B8C00, 0x13C0770, 0x13C3920, 0x13CE700, 0x13D00C0, 0x13D0E40, 0x13D27D0, 0x13DEAF0, 0x13DF880, 0x13E05E0, 0x13ED060, 0x140C9A0, 0x14149A0, 0x1420CC0, 0x1421A10, 0x1439F00, 0x14403A0, 0x1441D30, 0x144DD10, 0x144F680, 0x14558E0, 0x1461BE0, 0x146DEE0, 0x146F870, 0x14705D0, 0x1471330, 0x1473A70, 0x1789E10, 0x17903A0, 0x17E14F0, 0x1845210, 0x1859990, 0x185E300, 0x1863BF0, 0x1865570, 0x1874F30, 0x1886960, 0x189C220, 0x18D4F50, 0x18D5CB0, 0x18D7620, 0x18D8FA0, 0x18D9D10, 0x18DB6A0, 0x18E0CB0, 0x1C13020, 0x1C13AA0, 0x1C15170, 0x1C448E0, 0x1C842B0, 0x1C8CBB0, 0x1C92CF0, 0x1CB65E0, 0x1CBAF50, 0x1CC11B0, 0x1CC2B50, 0x1CC8DB0, 0x1DDE2B0, 0x1F16D60, 0x1F186D0, 0x1F18750, 0x1F294A0, 0x1F2D150, 0x1F40BC0, 0x1F58C00, 0x1F5A5A0, 0x1F5A620, 0x1F5D870, 0x1F68F40, 0x1F7ACD0, 0x1F7C670, 0x1F7C6F0, 0x1F87D50, 0x1F93FE0, 0x1F973B0, 0x1FA3350, 0x1FAA9E0, 0x1FB22E0, 0x1FBD0A0, 0x1FC3680, 0x206C0F0, 0x206DA90, 0x2082520, 0x20825A0, 0x208F710, 0x208F830];
// scanstring: ",127288,"
let scriptOffsets_f_nightclub_exterior = [0x0FE055, 0x11B95E, 0x11C002, 0x23D130, 0x291642, 0x2918D8, 0x2F653B, 0x2F69A5, 0x2FF537, 0x2FFD3D, 0x32AA93, 0x32AD5F, 0x32B02B, 0x32B2F7, 0x394C65, 0x3B6771, 0x43F365, 0x493400, 0x4938A3, 0x493CC8, 0x494375, 0x49540B, 0x496069, 0x496AE3, 0x49853C, 0x49A19A, 0x49AD25, 0x49AF8C, 0x49B151, 0x49B46C, 0x49B97A, 0x49BD54, 0x49BF4C, 0x49C170, 0x49D132, 0x49E0F4, 0x49F3D8, 0x49FDF8, 0x4A00E1, 0x4A0372, 0x4A06DF, 0x4A09F7, 0x4A0C01, 0x4A2ED6, 0x4A416B, 0x4A44BA, 0x4A4BF8, 0x4A50F1, 0x4A548F, 0x4A570B, 0x4A5A4A, 0x4A5DF5, 0x4A61A0, 0x4A652E, 0x4A68CB, 0x4A6BCC, 0x4A6E9A, 0x4A71FB, 0x4A7800, 0x4A7CAE, 0x4A7F5A, 0x4A8303, 0x4A8951, 0x4AA175, 0x4AB178, 0x4ABD7D, 0x4ACB34, 0x4AD86B, 0x4ADE0D, 0x4AF67D, 0x4B0CB9, 0x4B1496, 0x4B184B, 0x4B1BF1, 0x4B24BB, 0x4B2F53, 0x4B59F2, 0x4B6C35, 0x4B78DC, 0x4B7F66, 0x4B8744, 0x4B8FF8, 0x4B9584, 0x4B9E07, 0x4BA968, 0x4BB234, 0x4BBC6C, 0x4BC169, 0x4BC3A8, 0x4BD8C4, 0x4BE674, 0x4BEC5D, 0x4BF118, 0x4BF5FE, 0x4BFAE4, 0x4BFFCA, 0x4C04B1, 0x4C0999, 0x4C0E39, 0x4C151B, 0x4C1942, 0x4C29CD, 0x4C3857, 0x4C599B, 0x4C69E3, 0x4C6C88, 0x4C6E5B, 0x4C76B2, 0x4C7D62, 0x4C8234, 0x4C8791, 0x4C8C81, 0x4C95E4, 0x4C9D72, 0x4CA214, 0x4CA7A2, 0x4CADA4, 0x4CB3A6, 0x4CB9A8, 0x4CBCBF, 0x4CC50E, 0x4CCB7D, 0x4CCFD2, 0x4CD41C, 0x4CDA56, 0x4CDF7A, 0x4CE1F0, 0x4CFCAA, 0x4D09F2, 0x4D0D51, 0x4D0FF6, 0x4D2389, 0x4D2F40, 0x4D3B3B, 0x4D407B, 0x4D4E87, 0x4D599E, 0x4D5FA9, 0x4D6835, 0x4D7294, 0x4D7721, 0x4D7B1C, 0x4D7E5F, 0x4D8064, 0x4D876D, 0x4D8CDE, 0x4D9537, 0x4D9BAD, 0x4DB169, 0x4DBC84, 0x4DC294, 0x4DC617, 0x4DCB10, 0x4DD16C, 0x4DD462, 0x4DD9D8, 0x4DDE31, 0x4DE9F7, 0x4DF0C8, 0x5C02E8, 0x5F5F46, 0x737A5F, 0x76AA9B, 0x76B224, 0x76B3C5, 0x76B6EF, 0x76BAF1, 0x76C045, 0x76C614, 0x76CA73, 0x76CFBA, 0x76D581, 0x76D9DF, 0x76DD9E, 0x76E15F, 0x76E4BF, 0x76E7FB, 0x76EC68, 0x807472, 0x83CBFF, 0x876B43, 0x876EDA, 0x8774B7, 0x87792C, 0x8AA104, 0x8C4E8D, 0x8C727A, 0x8C81F9, 0x8C86BA, 0x8C8B7B, 0x8C903C, 0x8C94FD, 0x8C99BE, 0x8C9E7F, 0x8CA340, 0x8CA801, 0x8CACC3, 0x8CB185, 0x8CB646, 0x8CB8D2, 0x8CBAA4, 0x8CBC76, 0x8CBE48, 0x8CC01A, 0xA331AB, 0xA336A9, 0xA3398C, 0xA33BB0, 0xA33DFA, 0xA545A4, 0xA740B8, 0xA7B54B, 0xA7CF0D, 0xA8A803, 0xA8DADB, 0xA8DC7A, 0xA8DFCC, 0xA8E3DC, 0xA8E73B, 0xA8EB14, 0xA8EE71, 0xA8F2D3, 0xA8F720, 0xA8FA85, 0xA8FDEC, 0xA900CD, 0xA90459, 0xA90988, 0xA90F4F, 0xA91514, 0xA9190B, 0xA91BFE, 0xA91EF8, 0xA9234E, 0xCAB234, 0xCACB6F, 0xCACE57, 0xCAD11C, 0xCAD39F, 0xCAD5D8, 0xCAD8D6, 0xCADE5A, 0xCAE681, 0xCAED3C, 0xCAF260, 0xE35737, 0xE77D38, 0xE946D3, 0xE94A3D, 0xEAE98E, 0xEB8B0D, 0xEB9BD9, 0xEB9F9C, 0xEBA18D, 0xEBA48E, 0xEBA7D1, 0xEF9A6D, 0xEF9F4A, 0xEFA3F6, 0x108C259, 0x10AA00A, 0x10AA3AF, 0x10AA7DD, 0x123F204, 0x1277E83, 0x1286DD9, 0x12F07DD, 0x1302377, 0x13035D7, 0x1303A00, 0x1303D19, 0x13041FB, 0x13046B1, 0x13C3CAB, 0x13C4392, 0x13ED2FA, 0x140CC75, 0x14421BC, 0x14716F6, 0x1471A7E, 0x14743BA, 0x1474DCD, 0x14759A1, 0x14760AB, 0x147692F, 0x14772D4, 0x1477C15, 0x147857C, 0x1478B84, 0x1478EFE, 0x1479441, 0x147992A, 0x1479F9C, 0x147A78F, 0x1793764, 0x1794D8A, 0x17E17B8, 0x17E1E31, 0x184577D, 0x184619A, 0x189C54A, 0x189CA35, 0x18DBB12, 0x18E113C, 0x18E194F, 0x18E1F1D, 0x18E22F7, 0x18E26CB, 0x18E2B95, 0x18E32D4, 0x18E3734, 0x1C156AE, 0x1C44C41, 0x1C47AC7, 0x1C849E4, 0x1C90350, 0x1C927D1, 0x1CCB294, 0x1CCC556, 0x1CCC9EC, 0x1CCD4BA, 0x1DDE480, 0x1DDE6E4, 0x1DDE948, 0x1DDEC44, 0x1DE099C, 0x1DE197B, 0x1DE1E37, 0x1DE21A5, 0x1DE23B4, 0x1DE26BF, 0x1DE301A, 0x1DE3742, 0x1DE3E44, 0x1DE41AE, 0x1DE467F, 0x1DE4BFB, 0x1DE4F46, 0x1DE51B8, 0x1DE56C2, 0x1DE5A54, 0x1DE5FD7, 0x1DE6397, 0x1DE678C, 0x1DE6A87, 0x1DE739A, 0x1DE79ED, 0x1DE8392, 0x1DE9152, 0x1DE9746, 0x1DE994C, 0x1DE9C65, 0x1DE9FC1, 0x1DEA2A2, 0x1DEA54D, 0x1DEA7B8, 0x1DEAA8E, 0x1DEAD14, 0x1DEAFFF, 0x1DEB28F, 0x1DEB57A, 0x1DEB808, 0x1DEBAF3, 0x1DEBDC0, 0x1DEC047, 0x1DEC6A5, 0x1DECBC8, 0x1DECF24, 0x1DED21F, 0x1F2DC45, 0x1F69518, 0x1F7C7F1, 0x1F88845, 0x1F975E1, 0x1FB23E1, 0x1FC3893, 0x1FC3B55, 0x206DE0D];

// From https://docs.google.com/spreadsheets/d/1bdhTl2IvXVWOjnjhpgUTH0kg6e-RcioezIYrsi-_mso/edit#gid=0
// TODO: Should titles be world titles instead of ep?
const sceneDescs = [
    "The Black Chateau (Paris, France)",
    new Sly2LevelSceneDesc("f_nightclub_exterior", "The Black Chateau (Extermal)", objectOffsets_f_nightclub_exterior, scriptOffsets_f_nightclub_exterior),
];

const id = 'Sly2';
const name = 'Sly 2: Band of Thieves';
export const sceneGroup: SceneGroup = { id, name, sceneDescs };
